import "simpleitk"

dataset_root = "tests/data/datasets/BraTS_2019_HGG"

// Controls.
k = 10
hi_thr = 0.93
vi_thr_start = 83
vi_thr_stop = 92
vi_ticks = range(vi_thr_start, vi_thr_stop)
to_thr(tick) = tick / 100
vi_thresholds = map(to_thr, vi_ticks)

// Recursively discover BraTS FLAIR volumes and keep first k cases.
all_flair_paths = dir(dataset_root, "*_flair.nii.gz", true, true)
flair_paths = subsequence(all_flair_paths, 0, k)

// Paper method (simplified branch): lines 1-6 of the GBM specification.
// We sweep viThr in [0.83, 0.91] with step 0.01 while keeping hiThr fixed at 0.93.
read_image(path) = ReadImage(path)
to_intensity(img) = intensity(img)
preprocess_flair(flair) =
  let background = touch(leq_sv(0.1, flair), border) in
  let brain = not(background) in
  percentiles(flair, brain, 0)

sweep_case(pflair) =
  let hyper_intense = smoothen(geq_sv(hi_thr, pflair), 5.0) in
  for vi_thr in vi_thresholds do
    let very_intense = smoothen(geq_sv(vi_thr, pflair), 2.0) in
    grow(hyper_intense, very_intense)

// Debuggable sequence-of-maps pipeline.
flair_images = map(read_image, flair_paths)
flair_intensities = map(to_intensity, flair_images)
pflair_images = map(preprocess_flair, flair_intensities)

// Sequence of sequences: for each case, one mask per viThr value.
vi_sweep_masks = map(sweep_case, pflair_images)
