#!/bin/bash

# VoxLogicA wrapper script
# This script activates the virtual environment and runs the voxlogica command

# Get the directory where this script is located
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Virtual environment directory
VENV_DIR="$SCRIPT_DIR/.venv"

# If venv already exists, activate it first
if [ -f "$VENV_DIR/bin/activate" ]; then
	# shellcheck disable=SC1090
	source "$VENV_DIR/bin/activate"
	# Prepare the environment (idempotent install/update)
	python3 "$SCRIPT_DIR/bootstrap.py"
else
	# First-time setup: create venv, then activate, then finalize setup
	python3 "$SCRIPT_DIR/bootstrap.py"
	if [ -f "$VENV_DIR/bin/activate" ]; then
		# shellcheck disable=SC1090
		source "$VENV_DIR/bin/activate"
		python3 "$SCRIPT_DIR/bootstrap.py"
	else
		# Minimal fallback to allow execution attempt without activation
		export VIRTUAL_ENV="$VENV_DIR"
		export PATH="$VENV_DIR/bin:$PATH"
		unset PYTHONHOME
	fi
fi

# Set implementation/python as PYTHONPATH so the voxlogica package is always found
export PYTHONPATH="$SCRIPT_DIR/implementation/python"

# Run the Python VoxLogicA main module with all passed arguments
exec "$VIRTUAL_ENV/bin/python" -m voxlogica.main "$@"